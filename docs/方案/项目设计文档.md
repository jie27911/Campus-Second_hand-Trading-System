# 项目设计文档：异构多活分布式数据库同步与冲突处理系统

> 本文档以“数据库同步与冲突处理”为核心，按实验要求对照实现细节与可验证入口。

## 1. 项目目标与范围

- 目标：在真实业务（校园二手交易）上实现三库异构同步，并提供冲突检测、告警与人工处理闭环。
- 范围：
  - 业务：用户、商品、交易、消息、收藏等（≥5 张表）；
  - 同步：实时/定时两种模式；
  - 冲突：记录、通知、链接认证、管理端处理；
  - 性能：复杂 SQL 查询 + 索引优化。

## 2. 总体架构

### 2.1 拓扑与节点角色

- Edge North（MariaDB）：本部校区 OLTP 主库（就近读写）。
- Edge South（PostgreSQL）：南校区 OLTP 主库（就近读写）。
- Central Hub（MySQL）：汇聚库/协调中心。
  - 运行 Sync Core worker；
  - 存储同步配置、游标、冲突记录；
  - 承载管理端复杂分析查询（OLAP）。

### 2.2 进程与服务

- gateway：FastAPI 网关，提供业务 API + 管理 API。
- sync-worker：运行 `apps.services.sync_core_worker`，负责跨库复制与冲突判定。
- frontend：Vue 管理端与用户端。

## 3. 数据库设计

### 3.1 表结构一致性

三库保持核心业务表结构一致（字段、主键类型、同步元字段），并在 edge/hub 配置同步辅助表。

关键业务表（示例）：
- `users` / `user_profiles`
- `items` / `item_images`
- `transactions`
- `messages`
- `favorites`

同步相关表（Hub 为主）：
- `sync_configs`：同步拓扑配置（source/target/mode/interval/enabled）。
- `sync_worker_state`：worker 游标（last_event_id）。
- `sync_logs`：同步运行日志。
- `conflict_records`：冲突记录与处理状态。

### 3.2 主键策略：雪花 ID

- 目的：多主写入避免主键冲突。
- 实现：应用层写入监听器为新对象分配全局唯一 BIGINT。
  - MariaDB 侧默认 worker id=1
  - Postgres 侧默认 worker id=2
  - Hub MySQL 默认 worker id=0

## 4. 变更捕获与复制

### 4.1 Edge 触发器：捕获 sync_log + 维护 v_clock

- Edge 的触发器负责两件事：
  1）把行级变更快照写入 `sync_log`（INSERT/UPDATE/DELETE）；
  2）对 `v_clock` 进行本地递增（确保外部改库也有正确版本推进）。

### 4.2 复制写入抑制（避免回环）

- worker 在对目标库执行复制写入前设置抑制：
  - MySQL/MariaDB：`SET @sync_suppress = 1`
  - Postgres：`SET app.sync_suppress = '1'`
- 被抑制的写入不触发 v_clock 递增与 sync_log 记录，避免“复制引发复制”。

## 5. 同步核心：Sync Core Worker

### 5.1 工作流

1）从 Hub `sync_worker_state` 读取游标；
2）轮询 Edge `sync_log` 未处理记录（status=0）；
3）根据 `table_name / operation / data_id` 取出源快照与目标当前行；
4）解析 v_clock，判定：
   - **可覆盖**（支配关系成立）→ 写入目标；
   - **并发冲突**（互不支配）→ 写入 `conflict_records` 并触发通知；
5）标记 edge log 已处理并推进游标。

### 5.2 冲突模型

- 向量时钟格式：`{"N":counter,"S":counter}`
- 冲突判定：两个版本互不支配则为并发冲突。
- 冲突落库：Hub `conflict_records` 存储 source/target 与 payload 快照。

## 6. 冲突通知与“链接认证”

### 6.1 邮件通知

- worker 在检测到冲突后调用邮件通知服务（若 SMTP 配置可用），发送冲突摘要与处理链接。

### 6.2 链接 token 认证

- 系统生成带过期时间的 token（purpose=admin_ui），嵌入冲突处理链接。
- 管理员在 PC 或移动端打开链接后，后端解析 token 并完成身份验证/授权，再展示冲突详情。

## 7. 管理端：冲突处理与一致性验证

- 冲突列表：分页查询 `conflict_records`。
- 冲突解决：管理员选择以 source/target 为准或手动策略，后端执行复制并标记 resolved。
- 一致性校验：对某条记录跨库比对，辅助演示与调试。

## 8. 高级查询与性能优化（索引）

### 8.1 复杂 SQL

管理端高级查询包含：
- 多表 JOIN（users/items/transactions/campuses/categories）
- 嵌套子查询 / CTE
- 聚合统计（COUNT/SUM/AVG + GROUP BY）

### 8.2 索引设计

针对查询访问特征新增组合索引（Hub MySQL 为主，同时保持三库结构一致）：
- `items(status, category_id, campus_id)`：加速按状态过滤 + 分类/校区聚合。
- `transactions(status, seller_id, final_amount)`：加速按完成状态过滤 + 卖家汇总。
- `conflict_records(table_name, record_id)`：加速按表过滤 + 关联定位。

### 8.3 可验证方式

- 管理端提供 explain/benchmark，对比优化前后耗时。
- DB 侧可通过 EXPLAIN 观察索引命中。

## 9. 实验要求对照（摘要）

- 三种数据库：MySQL + MariaDB + PostgreSQL ✅
- 表结构一致 & ≥5 张表 ✅
- 用户/权限管理 ✅
- 复杂 SQL 页面 + 数据库端优化（索引/计划对比）✅
- 实时/定时同步 ✅
- 冲突邮件通知 + 链接认证 + PC 端处理 ✅

## 10. 运行与演示入口

- `docker compose up -d --build`
- 前端：`http://localhost:5173`
- 后端：`http://localhost:8000`
- 同步日志：`docker compose logs -f sync-worker`

