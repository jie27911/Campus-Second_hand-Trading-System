version: '3.8'

services:
  # ========================================
  # MySQL - 中央价格情报中心 (Hub)
  # ========================================
  mysql:
    image: mysql:8.0
    container_name: campuswap-mysql-hub
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-041210}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-campuswap_hub}
      MYSQL_USER: ${MYSQL_USER:-campuswap}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-041210}
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # ✅ 挂载初始化脚本目录
      - ./backend/sql/init/mysql:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-time-zone=+08:00
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-campuswap_root}"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      - campuswap-network
    restart: unless-stopped

  # ========================================
  # MariaDB - 本部校区 (Source A)
  # ========================================
  mariadb:
    image: mariadb:10.6
    container_name: campuswap-mariadb-main
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-041210}
      MARIADB_DATABASE: ${MARIADB_DATABASE:-campuswap_main}
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      # ✅ 挂载初始化脚本目录
      - ./backend/sql/init/mariadb:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-time-zone=+08:00
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      - campuswap-network
    restart: unless-stopped

  # ========================================
  # PostgreSQL - 南校区 (Source B)
  # ========================================
  postgres:
    image: postgres:14
    container_name: campuswap-postgres-branch
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-041210}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-campuswap_branch}
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # ✅ 挂载初始化脚本目录
      - ./backend/sql/init/postgres:/docker-entrypoint-initdb.d:ro
    command: ["postgres", "-c", "timezone=Asia/Shanghai"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d campuswap_branch"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      - campuswap-network
    restart: unless-stopped

  # ========================================
  # API Gateway - 多校区联邦交易云
  # ========================================
  gateway:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: campuswap-gateway
    environment:
      # 多校区数据库配置
      - MYSQL_DSN=mysql+pymysql://${MYSQL_USER:-campuswap}:${MYSQL_PASSWORD:-041210}@mysql:3306/${MYSQL_DATABASE:-campuswap_hub}          # 中央价格情报中心
      - MARIADB_DSN=mysql+pymysql://root:041210@mariadb:3306/campuswap_main    # 本部校区
      - POSTGRES_DSN=postgresql+psycopg://postgres:041210@postgres:5432/campuswap_branch  # 分校区
      - GLM_API_KEY=${GLM_API_KEY:-}66a92e33b49b43a2a21a3090455a884d.9tWKMmumiIwvSU01
      - GLM_MODEL=${GLM_MODEL:-glm-4-flash}
      - TZ=Asia/Shanghai
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./backend/static:/app/static
      - gateway_data:/app/data
    depends_on:
      mysql:
        condition: service_healthy
      mariadb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - campuswap-network
    restart: unless-stopped

  # ========================================
  # Frontend
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: campuswap-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_PROXY_TARGET=http://gateway:8000
      - VITE_IMAGE_PROXY_TARGET=http://gateway:8000
      - TZ=Asia/Shanghai
    networks:
      - campuswap-network
    restart: unless-stopped

  # ========================================
  # 同步Worker - 数据同步服务
  # ========================================
  sync-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: campuswap-sync-worker
    command: python -m apps.services.sync_core_worker
    environment:
      # 多校区数据库配置
      - MYSQL_DSN=mysql+pymysql://${MYSQL_USER:-campuswap}:${MYSQL_PASSWORD:-041210}@mysql:3306/${MYSQL_DATABASE:-campuswap_hub}          # 中央价格情报中心
      - MARIADB_DSN=mysql+pymysql://root:041210@mariadb:3306/campuswap_main    # 本部校区
      - POSTGRES_DSN=postgresql+psycopg://postgres:041210@postgres:5432/campuswap_branch  # 分校区
      - FRONTEND_BASE_URL=http://192.168.43.42:5173
      - TZ=Asia/Shanghai
    depends_on:
      - mysql
      - mariadb
      - postgres
      - gateway
    volumes:
      - ./backend:/app
    networks:
      - campuswap-network
    restart: unless-stopped

networks:
  campuswap-network:
    driver: bridge

volumes:
  mysql_data:
  mariadb_data:
  postgres_data:
  gateway_data:
  frontend_node_modules: